services:
  article-monitor:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: article-monitor
    
    # 关键优化 1: 增加共享内存大小
    # Chromium/Playwright 非常依赖 /dev/shm。Docker 默认只有 64MB，
    # 这会导致浏览器频繁崩溃 (Crash)。设置为 1gb 或 2gb 可解决此问题。
    shm_size: '2gb'

    # 关键优化 2: 启用 init 进程
    # 转发信号并清理僵尸进程，这对于包含多进程(如浏览器)的容器非常重要
    init: true

    ports:
      - "5000:5000"

    volumes:
      - ./data:/app/data
      - ./logs:/app/logs
      # 挂载时区文件，确保容器时间与宿主机完全同步
      - /etc/localtime:/etc/localtime:ro

    environment:
      - TZ=Asia/Shanghai
      # Playwright 配置（確保瀏覽器路徑一致）
      - PLAYWRIGHT_BROWSERS_PATH=/usr/local/share/playwright
      # Flask 配置
      - FLASK_HOST=0.0.0.0
      - FLASK_PORT=5000
      - FLASK_DEBUG=false
      # 爬取配置
      - CRAWL_INTERVAL_HOURS=6
      - CRAWL_CONCURRENCY=3
      - CRAWL_DELAY=1.0
      - CRAWL_MAX_RETRIES=10
      - CRAWL_RETRY_DELAY=2.0
      - CRAWL_RETRY_BACKOFF=1.5
      # 防反爬配置
      - ANTI_SCRAPING_ENABLED=true
      - ANTI_SCRAPING_ROTATE_UA=true
      - ANTI_SCRAPING_RANDOM_DELAY=true
      - ANTI_SCRAPING_STEALTH_MODE=true
      - ANTI_SCRAPING_MIN_DELAY=1.0
      - ANTI_SCRAPING_MAX_DELAY=5.0
      # 平台白名单（可选，留空则爬取所有支持的平台）
      # - ALLOWED_PLATFORMS=juejin,csdn,cnblogs
    
    restart: unless-stopped

    # 关键优化 3: 日志轮转
    # 防止容器日志无限制增长占满磁盘
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:5000/"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

    # 资源限制（根据服务器配置调整）
    deploy:
      resources:
        limits:
          cpus: '2.0'
          memory: 3072M
        reservations:
          memory: 1024M
