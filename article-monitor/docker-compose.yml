# 文章閱讀數監測 - Docker Compose
# 預設 2 核 2GB 低資源配置；主機 ≥3GB 時可提高 memory、shm_size 並取消 RESOURCE_PROFILE=low
# 可選：建立 .env（可從 .env.example 複製）後取消下方 env_file 註解，以覆蓋環境變數
services:
  article-monitor:
    build:
      context: .
      dockerfile: Dockerfile
    image: article-monitor:latest
    container_name: article-monitor

    # Chromium/Playwright 依賴 /dev/shm，預設 64MB 易崩潰；2C2G 用 1gb，主機充足可改 2gb
    shm_size: '1gb'
    # 轉發信號、清理殭屍進程（多進程/瀏覽器必需）
    init: true

    ports:
      - "5000:5000"

    volumes:
      - ./data:/app/data
      - ./logs:/app/logs
      - /etc/localtime:/etc/localtime:ro

    # env_file: .env   # 有 .env 時取消註解，可覆蓋下方環境變數
    environment:
      - TZ=Asia/Shanghai
      - PLAYWRIGHT_BROWSERS_PATH=/usr/local/share/playwright
      - FLASK_HOST=0.0.0.0
      - FLASK_PORT=5000
      - FLASK_DEBUG=false
      # 2C2G 低資源模式（並發 2、瀏覽器池 2、SQLite 2MB、健康檢查 4 線程）。主機 ≥3GB 可改為 RESOURCE_PROFILE= 或註解此行
      - RESOURCE_PROFILE=low
      # 爬取配置（RESOURCE_PROFILE=low 時 CRAWL_CONCURRENCY 預設為 2，可覆寫）
      - CRAWL_INTERVAL_HOURS=6
      - CRAWL_CONCURRENCY=2
      - CRAWL_DELAY=1.0
      - CRAWL_MAX_RETRIES=10
      - CRAWL_RETRY_DELAY=2.0
      - CRAWL_RETRY_BACKOFF=1.5
      # 防反爬配置
      - ANTI_SCRAPING_ENABLED=true
      - ANTI_SCRAPING_ROTATE_UA=true
      - ANTI_SCRAPING_RANDOM_DELAY=true
      - ANTI_SCRAPING_STEALTH_MODE=true
      - ANTI_SCRAPING_MIN_DELAY=1.0
      - ANTI_SCRAPING_MAX_DELAY=5.0
      # 平台白名单（可选，留空则爬取所有支持的平台）
      # - ALLOWED_PLATFORMS=juejin,csdn,cnblogs
    
    restart: unless-stopped

    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:5000/"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

    # 預設 2 核 2GB；主機 ≥3GB 可改 memory: 3072M、關閉 RESOURCE_PROFILE=low
    deploy:
      resources:
        limits:
          cpus: '2.0'
          memory: 2g
        reservations:
          memory: 512M
